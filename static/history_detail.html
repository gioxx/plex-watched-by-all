<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dettaglio episodi</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
    <header>
        <button class="pill" onclick="window.history.back()">← Back</button>
        <img src="/static/favicon.svg" alt="" width="32" height="32" />
        <div>
            <h1 id="seriesTitle">Serie</h1>
            <div class="muted" id="seriesInfo"></div>
        </div>
    </header>
    <main>
        <div id="seasons"></div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user') || '';
        const seriesId = params.get('seriesId') || '';
        const seriesName = params.get('seriesName') ? decodeURIComponent(params.get('seriesName')) : '';

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        document.getElementById('seriesTitle').textContent = seriesName || 'Serie';

        async function loadDetail() {
            if (!userId || !seriesId) {
                document.getElementById('seriesInfo').textContent = 'Missing parameters.';
                return;
            }
            const res = await fetch(`/api/user/${encodeURIComponent(userId)}/history`);
            const data = await res.json();
            const epis = (data.items || []).filter(e => e.seriesId === seriesId);
            if (epis.length === 0) {
                document.getElementById('seriesInfo').textContent = 'No episodes found.';
                return;
            }
            const bySeason = {};
            epis.forEach(ep => {
                const key = ep.seasonName || `Season ${ep.seasonIndex || ''}` || 'Season';
                if (!bySeason[key]) bySeason[key] = [];
                bySeason[key].push(ep);
            });
            Object.values(bySeason).forEach(arr => {
                arr.sort((a,b) => (b.date || 0) - (a.date || 0));
            });
            const seasons = Object.entries(bySeason).sort((a,b) => {
                const la = a[1][0]?.date || 0;
                const lb = b[1][0]?.date || 0;
                return lb - la;
            });
            const container = document.getElementById('seasons');
            container.innerHTML = seasons.map(([name, eps]) => {
                const lastDate = eps.reduce((m,e) => Math.max(m, e.date || 0), 0);
                const lastDateStr = lastDate ? new Date(lastDate * 1000).toLocaleString() : '—';
                const epiHtml = eps.map(e => {
                    const code = (e.seasonIndex != null && e.episodeIndex != null)
                        ? `S${String(e.seasonIndex).padStart(2,'0')}E${String(e.episodeIndex).padStart(2,'0')}`
                        : '';
                    const when = e.date ? new Date(e.date * 1000).toLocaleString() : '—';
                    const coverSrc = e.thumb || e.jellyfinThumb || '';
                    const cover = coverSrc
                        ? `<img src="${escapeHtml(coverSrc)}" alt="">`
                        : `<span class="muted">No poster</span>`;
                    const epTitle = (e.title && e.title !== seriesName) ? e.title : (e.episodeTitle || '');
                    const seasonLabel = e.seasonName || '';
                    return `<div class="episode">
                        <div class="episode-cover">${cover}</div>
                        <div style="flex:1 1 auto;">
                            <div class="epi-title">${escapeHtml(code ? code + ' · ' : '')}${escapeHtml(epTitle)}</div>
                            <div class="epi-sub">${escapeHtml(seasonLabel)}</div>
                        </div>
                        <div class="epi-sub">Viewed: ${escapeHtml(when)}</div>
                    </div>`;
                }).join('');
                return `<div class="season-block">
                    <div class="season-head">
                        <div>
                            <div class="epi-title section-title" style="padding-top:0;">${escapeHtml(name)}</div>
                            <div class="epi-sub">Last viewed: ${escapeHtml(lastDateStr)}</div>
                        </div>
                        <div class="epi-sub">${escapeHtml(eps.length)} episode(s)</div>
                    </div>
                    <div class="episode-list">${epiHtml}</div>
                </div>`;
            }).join('');

            document.getElementById('seriesInfo').textContent = `${seriesName || ''} · ${epis.length} episode(s)`;
        }

        loadDetail();
    </script>
</body>
</html>
